<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Docker: Host Volumes and Host User/Group identifiers</title>
  <meta name="description" content="Hard to understand">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/2015/09/20/docker-host-volume-user-permissions.html">
  <link rel="alternate" type="application/rss+xml" title="Thought.out.printf()" href="http://yourdomain.com/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Thought.out.printf()</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Docker: Host Volumes and Host User/Group identifiers</h1>
    <p class="post-meta">Sep 20, 2015</p>
  </header>

  <article class="post-content">
    <h1>Hard to understand</h1>

<p>Even for proficient and experienced Linux/Unix users it is sometimes
not easy to become a Docker-savvy.</p>

<p>Although Docker is all about putting software in a box, it equally
requires you to think outside the box you create and consider the host
context. Especially, if you are aiming for as portable docker
containers as possible.</p>

<p>A difficulty in creating portable containers is mounting writable host
volumes into containers and understand how the mapping of the
user/group identifiers within the container and the user/group
identifiers of the host works. Please be aware that the best approach
is the
<a href="https://docs.docker.com/userguide/dockervolumes/#creating-and-mounting-a-data-volume-container">data volume container approach</a>. However,
by default &ndash; and therefore on allmost all hosts &ndash; the
maximum size of a container is 10GB. You only need host mounted
volumes in cases where you are regularly handling data of sizes beyond
10GB.</p>

<p>In a nutshell, I think the most important aspects to know are:</p>

<ul>
<li>Volumes are created <strong>ONCE</strong> during container creation</li>
<li>The host has its own
<a href="https://en.wikipedia.org/wiki/User_identifier">user identifiers</a>
(uid) and
<a href="https://en.wikipedia.org/wiki/Group_identifier">group identifiers</a>
(gid) totally independent from the container&#39;s uids and gids</li>
<li>For bind-mounts the host&#39;s uids and gids are taken &#39;as is&#39; in the
container and the container writes with the uids and gids of the
user in the container. This is by default the root user who has
uid=0 and gid=0.</li>
</ul>

<h1>Easy practical approach since Docker 1.8</h1>

<p>After digging through several approaches, the one that works best for
me is what I call the &quot;Container&#39;s Host Common Group Approach&quot; to
ensure that files written by the container process seamlinglessly
match the host settings.</p>

<p>That is:</p>

<ol>
<li>Create one or many groups on the host with a certain gid

<ul>
<li>I like to name the host group
<a href="https://en.wikipedia.org/wiki/Dockmaster"><em>dockmaster</em></a> and
give it gid 1496
<a href="https://en.wikipedia.org/wiki/Intermodal_container">(one of the ISO standard number for real intermodal containers ;) )</a></li>
</ul></li>
<li>Create a directory on host with dockmaster group and add the
<a href="https://en.wikipedia.org/wiki/Setuid">&quot;set group ID upon execution&quot; (setgid) bit</a></li>
<li>Start a docker container mounting the host directory and assign the
host group id to the user within the container by using <em>--group-add</em> option

<ul>
<li>This feature is only available since docker 1.8 <a href="https://github.com/docker/docker/releases/tag/v1.8.0">(a feature not
announced by docker!!)</a>. But
it is documented in docker man page and also see <a href="https://github.com/docker/docker/pull/10717">pull request for details</a>. </li>
</ul></li>
</ol>

<p>That&#39;s about it.</p>

<h2>Detailed example</h2>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># step 1</span>
<span class="c"># creating common host group</span>
<span class="nv">$ </span>sudo useradd -M --uid <span class="m">1496</span> --user-group dockmaster

<span class="c"># step 2</span>
<span class="c"># creating host directory</span>
<span class="nv">$ </span>mkdir -p /tmp/common-group-host-dir
<span class="c"># setting setgid bit and mke it writable</span>
<span class="nv">$ </span>sudo chmod g+ws /tmp/common-group-host-dir/
<span class="c"># make dockmaster owner</span>
<span class="nv">$ </span>sudo chown dockmaster:dockmaster /tmp/common-group-host-dir/
<span class="nv">$ </span>ls -lha /tmp/common-group-host-dir/

total 16K
drwxrwsr-x  <span class="m">2</span> dockmaster dockmaster 4.0K Sep <span class="m">20</span> 13:47 .
drwxrwxrwt <span class="m">11</span> root       root        12K Sep <span class="m">20</span> 13:48 ..

<span class="c"># step 3</span>
<span class="c"># starting container </span>
sudo docker run <span class="se">\</span>
-v /tmp/common-group-host-dir:/tmp/common-group-container-dir <span class="se">\</span>
--user <span class="m">1496</span> <span class="se">\</span>
--group-add <span class="m">1496</span>  <span class="se">\</span>
-ti --rm <span class="se">\</span>
debian:jessie /bin/bash

<span class="c"># now in container</span>
I have no name!@d2165449e550:/<span class="nv">$ </span>touch /tmp/common-group-container-dir/test-file

<span class="c"># check directory content from within container</span>
I have no name!@d2165449e550:/<span class="nv">$ </span>ls -lha /tmp/common-group-container-dir/
total 8.0K
drwxr-sr-x <span class="m">2</span> <span class="m">1496</span> <span class="m">1496</span> 4.0K Sep <span class="m">20</span> 11:47 .
drwxrwxrwt <span class="m">3</span> root root 4.0K Sep <span class="m">20</span> 11:47 ..
-rw-r--r-- <span class="m">1</span> <span class="m">1496</span> <span class="m">1496</span>    <span class="m">0</span> Sep <span class="m">20</span> 11:47 <span class="nb">test</span>-file

<span class="c"># now back to host</span>
I have no name!@d2165449e550:/<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># on host</span>
<span class="nv">$ </span>ls -lha /tmp/common-group-host-dir/

total 16K
drwxr-sr-x  <span class="m">2</span> dockmaster dockmaster 4.0K Sep <span class="m">20</span> 13:47 .
drwxrwxrwt <span class="m">11</span> root       root        12K Sep <span class="m">20</span> 13:48 ..
-rw-r--r--  <span class="m">1</span> dockmaster dockmaster    <span class="m">0</span> Sep <span class="m">20</span> 13:47 <span class="nb">test</span>-file
</code></pre></div>
<p>So, in step 1 we create a user and group with name <em>dockmaster</em> and
uid/gid <em>1496</em>. We then create a directory
<em>/tmp/common-group-container-dir/</em> make it writable for the group and
add the setgid bit with <em>chmod g+ws</em>. Lastly, we make <em>dockaster</em> the
user and group owner of that directory.</p>

<p>The final 3rd step demonstrates the effect of running a container
with <em>--group-add 1496</em> and <em>--user 1496</em>. Two apsects are important
here:</p>

<ol>
<li>Only <em>--group-add 1496</em> is necessary here</li>
<li>The gid must be given as the numeric number. If you provide a
symbolic group name docker searches in posix compliant way for the
group name in <em>/etc/group</em> of the container, which does not exist in
this case.</li>
<li><em>--user 1496</em> is not necessary. This option demonstrates that one
can add a user on the fly and hence run a container as
non-root. This follows a
<a href="https://github.com/docker/docker-bench-security">basic security advice</a>
and
<a href="https://docs.docker.com/articles/dockerfile_best-practices/#user">docker best practice</a>.
.</li>
</ol>

<h1>Summary</h1>

<p>With this solution the host operator can create directories and let
container users create and write in it &ndash; whoever the container
user is &ndash; by just passing the group id of the host directory via
the <em>--add-group</em> option. From the container perspective: the user can
write into volumes without the need to perform any user mapping
activities nor the need to know anything about the host
configuration. The permissions are fully controlled by the host
operator running docker containers.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Thought.out.printf()</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Thought.out.printf()</li>
	  
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/renzok">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">renzok</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/renzokott">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">renzokott</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Becoming a literate developer, building common understanding.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
